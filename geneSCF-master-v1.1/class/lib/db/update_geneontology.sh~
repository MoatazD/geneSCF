#!/bin/bash
organism=$1;
DIR=$2;
#GeneDB_Lmajor,GeneDB_Pfalciparum,GeneDB_Tbrucei,PAMGO_Atumefaciens,PAMGO_Ddadantii,PAMGO_Mgrisea,PAMGO_Oomycetes,aspgd,cgd,dictyBase,ecocyc,fb,goa_chicken,goa_cow,goa_dog,goa_human,goa_pdb,goa_pig,goa_ref_chicken,goa_ref_cow,goa_ref_dog,goa_ref_human,goa_ref_pig,goa_uniprot_noiea,goa_uniprot,gramene_oryza,jcvi,mgi,pombase,pseudocap,rgd,sgd,sgn,tair,wb,zfin,
#Depends on the database of the organism the taxonid should change in gene_info extraction cat $DIR/class/lib/db/gene_info | grep "^9606" | awk -F '\t' '{print $3"\t"$2;}' > $DIR/class/lib/db/$organism/geneSymWithID.txt;
mkdir  $DIR/class/lib/db/$organism

wget -P  $DIR/class/lib/db/$organism/ http://purl.obolibrary.org/obo/go.obo;
wget -P  $DIR/class/lib/db/$organism/ http://geneontology.org/gene-associations/gene_association.${organism}.gz;

#gene_association.goa_human.gz renamed gene_association.goa_human140122

gzip -d  $DIR/class/lib/db/$organism/gene_association.${organism}.gz;

cat  $DIR/class/lib/db/$organism/go.obo | grep "^id\:" | sed 's/id: //' >  $DIR/class/lib/db/$organism/GO_id.txt;
cat  $DIR/class/lib/db/$organism/go.obo | grep "^name\:" | sed 's/name: //' >  $DIR/class/lib/db/$organism/GO_desc.txt;
cat  $DIR/class/lib/db/$organism/go.obo | grep "^namespace\:" | sed 's/namespace: //' >  $DIR/class/lib/db/$organism/GO_process.txt;
paste  $DIR/class/lib/db/$organism/GO_id.txt  $DIR/class/lib/db/$organism/GO_desc.txt >  $DIR/class/lib/db/$organism/GOWithDesc.txt;
paste  $DIR/class/lib/db/$organism/GOWithDesc.txt  $DIR/class/lib/db/$organism/GO_process.txt | awk -F '\t' '{print $1"\t"$3"\t"$2;}' >  $DIR/class/lib/db/$organism/GOWithDescProcess.txt;

org_taxid=`cat $DIR/class/lib/db/$organism/gene_association.${organism} | grep -v "\!" | cut -f13 | head -n1 | sed 's/taxon\://'`;
cat  $DIR/class/lib/db/$organism/gene_association.${organism} | grep -v "\!" | awk 'BEGIN{FS="\t"}{if($12~"gene") print $3"\t"$5"\t"$9;}' | awk '!x[$0]++'>  $DIR/class/lib/db/$organism/all_go.tmp;
cat  $DIR/class/lib/db/$organism/all_go.tmp | awk '{print $2"\t"$1}' >  $DIR/class/lib/db/$organism/temp.txt;

awk 'BEGIN{FS="\t"}{ if( !seen[$1]++ ) order[++oidx] = $1; stuff[$1] = stuff[$1] $2 "," } END { for( i = 1; i <= oidx; i++ ) print order[i]"\t"stuff[order[i]] }'  $DIR/class/lib/db/$organism/temp.txt >  $DIR/class/lib/db/$organism/gene_association.grouped.txt;

cat  $DIR/class/lib/db/$organism/gene_association.grouped.txt | cut -f1 >  $DIR/class/lib/db/$organism/temp.txt;

perl $DIR/class/scripts/common.pl  $DIR/class/lib/db/$organism/GOWithDescProcess.txt  $DIR/class/lib/db/$organism/temp.txt $DIR >  $DIR/class/lib/db/$organism/gene_association.grouped.annotation;

paste  $DIR/class/lib/db/$organism/gene_association.grouped.annotation  $DIR/class/lib/db/$organism/gene_association.grouped.txt | awk -F'\t' '{print $1"~"$3"\t"$2"\t"$5;}' >  $DIR/class/lib/db/$organism/gene_association.grouped.annotated.txt;

#cat gene_association.grouped.annotated.txt | awk -F'\t' -vOFS='\t' '{gsub(",","\t",$3);}{print ;}' > gene_association.grouped.annotated_formatted.txt;

cat  $DIR/class/lib/db/$organism/gene_association.grouped.annotated.txt | awk 'BEGIN{FS="\t"}{if($2~"molecular_function") print $1"\t"$3;}' >  $DIR/class/lib/db/$organism/GO_MF_sym.txt;
cat  $DIR/class/lib/db/$organism/gene_association.grouped.annotated.txt | awk 'BEGIN{FS="\t"}{if($2~"cellular_component") print $1"\t"$3;}' >  $DIR/class/lib/db/$organism/GO_CC_sym.txt;
cat  $DIR/class/lib/db/$organism/gene_association.grouped.annotated.txt | awk 'BEGIN{FS="\t"}{if($2~"biological_process") print $1"\t"$3;}' >  $DIR/class/lib/db/$organism/GO_BP_sym.txt;
cat  $DIR/class/lib/db/$organism/gene_association.grouped.annotated.txt | awk 'BEGIN{FS="\t"}{print $1"\t"$3;}'>  $DIR/class/lib/db/$organism/GO_all_sym.txt;


#WITH ID's

#wget -P  $DIR/class/lib/db/ ftp://ftp.ncbi.nlm.nih.gov/gene/DATA/gene_info.gz;
#gzip -d  $DIR/class/lib/db/gene_info.gz;
#cat $DIR/class/lib/db/gene_info | grep -v "^#" | awk -F '\t' '{print $1"\t"$3"\t"$2;}' > $DIR/class/lib/db/gene_info_limit;
#rm $DIR/class/lib/db/gene_info;
############## Please change taxon for different organisms
gzip -d $DIR/class/lib/db/gene_info_limit.gz
cat $DIR/class/lib/db/gene_info_limit | grep -w "^$org_taxid" | awk -F '\t' '{print $2"\t"$3;}' > $DIR/class/lib/db/$organism/geneSymWithID.txt;
gzip $DIR/class/lib/db/gene_info_limit;

awk 'BEGIN{FS="\t"}{ if( !seen[$1]++ ) order[++oidx] = $1; stuff[$1] = stuff[$1] $2 "," } END { for( i = 1; i <= oidx; i++ ) print order[i]"\t"stuff[order[i]] }' $DIR/class/lib/db/$organism/geneSymWithID.txt | sed 's/,$//' > $DIR/class/lib/db/$organism/geneSymWithID_DupGrpd.txt;

perl $DIR/class/scripts/replaceIDS.pl $DIR/class/lib/db/$organism/GO_MF_sym.txt $DIR/class/lib/db/$organism/geneSymWithID_DupGrpd.txt $DIR > $DIR/class/lib/db/$organism/GO_MF_gid.txt
perl $DIR/class/scripts/replaceIDS.pl $DIR/class/lib/db/$organism/GO_CC_sym.txt $DIR/class/lib/db/$organism/geneSymWithID_DupGrpd.txt $DIR > $DIR/class/lib/db/$organism/GO_CC_gid.txt
perl $DIR/class/scripts/replaceIDS.pl $DIR/class/lib/db/$organism/GO_BP_sym.txt $DIR/class/lib/db/$organism/geneSymWithID_DupGrpd.txt $DIR > $DIR/class/lib/db/$organism/GO_BP_gid.txt
perl $DIR/class/scripts/replaceIDS.pl $DIR/class/lib/db/$organism/GO_all_sym.txt $DIR/class/lib/db/$organism/geneSymWithID_DupGrpd.txt $DIR > $DIR/class/lib/db/$organism/GO_all_gid.txt


rm $DIR/class/lib/db/$organism/all_go.tmp  $DIR/class/lib/db/$organism/gene_association.${organism}  $DIR/class/lib/db/$organism/gene_association.grouped.annotated.txt  $DIR/class/lib/db/$organism/gene_association.grouped.annotation  $DIR/class/lib/db/$organism/gene_association.grouped.txt  $DIR/class/lib/db/$organism/go.obo  $DIR/class/lib/db/$organism/GO_desc.txt  $DIR/class/lib/db/$organism/GO_id.txt  $DIR/class/lib/db/$organism/GO_process.txt  $DIR/class/lib/db/$organism/GOWithDesc.txt  $DIR/class/lib/db/$organism/GOWithDescProcess.txt  $DIR/class/lib/db/$organism/temp.txt $DIR/class/lib/db/$organism/geneSymWithID.txt $DIR/class/lib/db/$organism/geneSymWithID_DupGrpd.txt

